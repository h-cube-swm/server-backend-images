# The-Form Backend-Images

이 프로젝트는 설문조사플랫폼 The-Form의 이미지 업로드를 위한 백엔드 서버입니다.

## 의사결정과정

### 요구 사항

해당 서버는 다음과 같이 세 종류가 요구된다.

1. 프론트엔드에서 API 요청

- 이때 메소드 형태는 POST로 Body Parameter로 이미지, 설문 고유 아이디, 유저 아이디를 포함하여 보낼 수 있어야 한다.

2. 프론트엔드에서 보낸 이미지를 아마존 S3와 같은 스토리지에 업로드

- 이때 이미지 파일에 문제가 없는지 검사를 할 수 있어야 한다.
- 이때 이미지 파일의 사이즈를 최적화 할 수 있어야 한다.

3. 프론트엔드에 이미지 URL 응답

- 이때 S3에 올라간 이미지 URL을 전달할 수 있어야 한다.

### 추가적으로 고려해야하는 것

1. 유저가 API를 마음대로 요청할 수 있으면 안됨
2. S3의 접근은 특정 폴더(유저 설문 이미지 관련)는 Public하게 읽기가 가능해야 하고, 쓰기는 지정된 역할(우리의 경우 프론트엔드)에서만 가능해야 함
3. S3 액세스 포인트를 image.the-form과 같은 URL과 연동해야함
4. 이미지의 경우 Body Parameter의 타입 중 form-data 형태로 보낼 수 밖에 없기에 이에 알맞은 파싱 기법 요구됨
5. 여러 요청이 동시에 와도 데이터를 유실하지 않고 스케일러블하게 응답할 수 있어야 함

### 1차 기획

처음에는 단순하게 S3 접근에 대해 프론트엔드에 위임을 하고, 직접 업로드가 가능하게 하는 방향을 생각했다.  
이렇게 생각한 이유는 굳이 이미지를 백엔드에 서빙하게 되면 multipart 파일을 쥐고 있어야 하는 등의 리소스 낭비가 크다고 생각했기 때문이다.  
이같은 방법은 혼자 연습용 프로젝트에서나 유효하다. 절대적으로 프론트엔드에 시크릿키를 넣거나 하는 방법은 피해야한다.

둘째로는 이미지 백엔드 서버에 프론트엔드가 요청을 하면 S3에 접근할 수 있는 presigned URL을 발급하는 방법을 생각했다.  
역시 굳이 이미지를 백엔드에 서빙하는 리소스 낭비가 크다고 생각했기 때문이다.  
하지만 역시 이미지 파일을 가장한 이상한 파일이나, 이미지 리사이징 관련한 해결법으로 백엔드를 거쳐가는 것으로 결정하게 됐다.

**추가적으로 고려해야하는 것**의 5번에 초점을 맞춰 AWS Lambda를 기반으로 분리하여 API를 제공하고자 했다.  
람다를 선택한 이유는 이러하다.

1. 메인 서비스 API 형태와 충분히 분리가 가능하고, 이미지 관련 역할만 하는 서버로 따로 분리하고자 함
2. 비즈니스 로직만 만들어두면 이후에 관리 포인트가 적다는 장점(AWS 자체에서 관리)
3. AWS 콘솔에서 작업이 가능하다는 점
4. 개인의 기술적 성장

전체적인 아키텍처는 이러하다.  
API gateway에서 요청을 받고 해당 요청을 Lambda로 연동 및 RDS Mysql 데이터베이스에 저장.  
이때 IAM과 VPC 등을 활용하여 보안성 역시 향상.

#### 문제점

이와 같은 구조에 문제점이 여러개 발생했다.

1. Lambda 자체를 개발 중에 테스트하는 것의 어려움

- 코드를 작성하고, ZIP파일로 업로드하고, 테스트해야함. 간단한 로그또한 cloudwatch에서 확인해야함.  
  이를 해결해주는 Serverless같은 플랫폼이 있지만 그마저도 한번 배포하는데 오래 걸리고, cloudformation, s3 등 aws 리소스를 더 활용하게 되고, 학습해야할게 더 많아진다.

2. Lambda와 RDB의 커넥션 풀 문제

- RDB의 경우 한번 통신하고 끝나는 DB가 아니고 직접적으로 커넥션을 맺어서 통신한다. 이때 한번에 연결을 맺을 수 있는 max_connections라는 것이 존재하는데,  
  우리의 한정된 자원과 지금의 서비스 스케일에서는 프리티어 상품을 고를 수 밖에 없는데 이는 최대 64 커넥션만 지원을 한다.  
  당연하게도 단순하게 max_connections 값만 올린다고 해결되는 문제가 아닌(성능은 그대로인데 억지로 숫자를 올린다고 해결안됨) 임시적으로 상품을 Scale-Up 하거나, 근본적으로 해결해야 한다.  
  connection 삭제는 데이터베이스 TTL에 의지하고 Lambda가 명시적으로 닫을 수 없기에 connection 풀 생성을 글로벌 섹션에 빼는 방법이 있기는 한데,  
  Lambda와 DB 중간에 관리용 EC2 등을 두거나, Elasticsearch 등을 두거나, RDS Proxy 등을 두어서 connection 풀을 관리하는 gateway를 구축하는 방향이 있다.  
  그리고 node.js의 경우 context.callbackWaitsForEmptyEventLoop = false로 설정해주는 방법도 있다.  
  하지만 이에 대해서도 학습이 필요하고 개인의 기술적 성장과 비교했을 때 손실이 더 크다.

3. 쌩 node.js의 어려움

- Lambda에서는 공식적으로 node.js를 지원하는데, 요청에 대한 return을 처리하는 것에 대해 기존에 사용하던 express 대비 공수가 더 들어간다.  
  예를들면 최근에는 3시간 이상 OPTIONS 메소드의 처리를 못해줌으로써 프론트엔드 요청 테스트에 지연이 생긴 경험이 있다.  
  여기서도 물론 aws-serverless-express와 같은 라이브러리를 활용할 수 있기는 하지만, 기존에 사용하던 express 컨테이너를 재활용하는 편이 시간적으로나, 공수적으로나 이득이다.  
  Lambda node는 또한 기본적으로 callback, return이 실행되어도 바로 종료되지 않는다고 한다.  
  이벤트루프에 람다 타임아웃이 될 때까지 계속 실행되고 있다고 한다.  
  즉 정리하자면, Lambda는 커넥션 이후에 RDS의 커넥션 시간이 끝나거나 Lambda 타임아웃이 될 대까지 계속 커넥션 하나를 물고 실행중인 상태가 되는 것이다.  
  이를 해결하기 위해 RDS 커넥션의 시간도 줄이고 위의 2번에서 설정한 context.callbackWaitsForEmptyEventLoop = false 설정할 수 있겠지만 그 역시도 어떤 파급 효과를 일으킬지 알 수 없는 상태다.

결론적으로, 기존의 express 컨테이너를 재활용하는 편으로 업데이트하기로 하였다.

### 업데이트된 기획

**추가적으로 고려해야하는 것**의 1번과 3번의 쓰기 제한을 생각해보자.  
유저가 API를 마음대로 요청할 수 없게하려면 단순히 HOST 제한만으로는 부족하다.  
Postman 등 API-Tester에서는 해당 부분을 수정할 수 없게 제한하고, 개인적으로 Python requests 모듈에서 테스트해본 결과 수정이 안되는 것을 확인했다(추후 추가 확인 필요).  
하지만 근본적으로 패킷을 위조하는 것은 당연히 가능한 것이기에, 추가적인 대안이 필요하다.

우리는 1차적으로는 로그인 한 유저의 JWT 토큰을 기반으로 해당 토큰이 우리의 공개키로 해독되는 경우에만 API 요청이 가능하게 하고자 한다.  
이에 대한 근거는 이러하다.

1. 구글폼, 네이버폼 전부 로그인이 안된 상태에서 폼 만드는 것을 허용하지 않는다.
2. 타 서비스 타입폼이나 모아폼, 오픈서베이 같은 경우에도 디폴트로 로그인이 요구된다.

로그인 안한 유저에게는 기본적은 것만 제공하고, 이미지 추가라는 추가 기능에 제한을 검으로써 우리의 회원가입으로 유도될 수 있다.

위의 조치만으로 대부분이 해결되겠지만, 그럼에도 문제점이 존재한다.  
만약 회원가입까지 한 악성유저가 Authorization 헤더에 자신의 토큰값을 넣어서 요청을 하면 어떻게 될까?  
이에 대한 해결방안으로 제시하는 것은,

1. 유저 아이디를 기반으로 최대 요청 횟수 제한
2. 특정 횟수 이상으로 악의적인 요청을 하는 유저에 대한 블랙리스트 처리(유저 아이디로 식별이 가능하기에)
3. 서버 측에서 특정 토큰을 발급하여, 해당 토큰이 있는 경우에만 요청 가능하게 처리(만기 시간은 최대한 짧게)

이러한 방향성이 있다.  
해당 부분은 추후 논의하고자 한다.
